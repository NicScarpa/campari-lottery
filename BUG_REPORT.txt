================================================================================
                    CAMPARI LOTTERY - BUG REPORT DETTAGLIATO
================================================================================
Data analisi: 17 Dicembre 2025
Versione: Current main branch
Analista: Claude Code (Analisi automatizzata)

================================================================================
                              SOMMARIO ESECUTIVO
================================================================================

Totale problemi identificati: 18
- CRITICI (da risolvere immediatamente): 3
- ALTI (da risolvere prima del rilascio): 5
- MEDI (da pianificare): 6
- BASSI (miglioramenti consigliati): 4

================================================================================
                          PROBLEMI CRITICI (Priorita 1)
================================================================================

------------------------------------------------------------------------------
BUG #1: RESPONSIVENESS DASHBOARD MOBILE - SOVRAPPOSIZIONE SIDEBAR
------------------------------------------------------------------------------
File: frontend/app/admin/dashboard/page.tsx
       frontend/app/admin/dashboard/components/Sidebar.tsx

DESCRIZIONE:
Su dispositivi mobile (width < 768px), la sidebar si sovrappone al contenuto
principale della dashboard, rendendo l'interfaccia inutilizzabile.

RIPRODUZIONE:
1. Accedere a /admin/dashboard
2. Ridimensionare la finestra a 375x812px (iPhone)
3. Osservare la sovrapposizione della sidebar sul contenuto

IMPATTO: Gli amministratori non possono utilizzare la dashboard da mobile.

SOLUZIONE CONSIGLIATA:
- Implementare un menu hamburger per mobile
- Nascondere la sidebar su viewport < 768px
- Aggiungere un overlay quando la sidebar e aperta su mobile

------------------------------------------------------------------------------
BUG #2: DIVISIONE PER ZERO IN STATSCARD
------------------------------------------------------------------------------
File: frontend/app/admin/dashboard/components/StatsCard.tsx
Linea: 92

DESCRIZIONE:
Se non ci sono token (stats.tokenStats.total = 0), la percentuale di
avanzamento diventa NaN per divisione per zero.

CODICE PROBLEMATICO:
const percentageUsed = (stats.tokenStats.used / stats.tokenStats.total) * 100;

IMPATTO: La UI mostra "NaN%" invece di "0%"

SOLUZIONE CONSIGLIATA:
const percentageUsed = stats.tokenStats.total > 0
    ? (stats.tokenStats.used / stats.tokenStats.total) * 100
    : 0;

------------------------------------------------------------------------------
BUG #3: CRASH POTENZIALE IN PROMOTIONSELECTOR
------------------------------------------------------------------------------
File: frontend/app/admin/dashboard/components/PromotionSelector.tsx
Linea: 159-161

DESCRIZIONE:
Nel metodo handleDeletePromotion, dopo l'eliminazione viene fatto accesso a
remaining[0].id senza verificare che l'array abbia elementi.

CODICE PROBLEMATICO:
const remaining = promotions.filter(p => String(p.id) !== String(currentPromotion.id));
onSelectPromotion(remaining[0].id);  // CRASH se remaining e vuoto

NOTA: C'e un check preventivo (promotions.length <= 1) ma potrebbe esserci
una race condition se i dati cambiano durante l'operazione.

SOLUZIONE CONSIGLIATA:
if (remaining.length > 0) {
    onSelectPromotion(remaining[0].id);
}

================================================================================
                          PROBLEMI ALTI (Priorita 2)
================================================================================

------------------------------------------------------------------------------
BUG #4: GENERAZIONE TOKEN PREVEDIBILE
------------------------------------------------------------------------------
File: backend/src/server.ts
Linea: 653

DESCRIZIONE:
I codici token sono generati usando Math.random() che non e crittograficamente
sicuro. Un attaccante potrebbe potenzialmente predire i codici futuri.

CODICE PROBLEMATICO:
const code = (prefix || '') + Math.random().toString(36).substring(2, 8).toUpperCase();

IMPATTO: Potenziale vulnerabilita di sicurezza per previsione token.

SOLUZIONE CONSIGLIATA:
import crypto from 'crypto';
const code = (prefix || '') + crypto.randomBytes(4).toString('hex').toUpperCase();

------------------------------------------------------------------------------
BUG #5: RISORSE 404 - IMMAGINE MANCANTE
------------------------------------------------------------------------------
File: frontend/app/classifica/[promotionId]/page.tsx
      frontend/app/play/page.tsx

DESCRIZIONE:
La console mostra errori 404 per risorse mancanti:
- /bottiglia.png (usata come pattern di sfondo)

RIPRODUZIONE:
1. Aprire /classifica/1
2. Controllare la console del browser
3. Osservare errore 404 per bottiglia.png

IMPATTO: Pattern di sfondo non visualizzato correttamente.

SOLUZIONE CONSIGLIATA:
- Verificare che bottiglia.png sia presente in frontend/public/
- Oppure rimuovere il riferimento se non necessario

------------------------------------------------------------------------------
BUG #6: ERRORI 403 FORBIDDEN SU FONT
------------------------------------------------------------------------------
Console Error durante navigazione

DESCRIZIONE:
Errori 403 Forbidden vengono mostrati per alcune risorse font durante la
navigazione, specialmente sulla pagina di login.

IMPATTO: Potenziale problema di CORS o configurazione server per font.

SOLUZIONE CONSIGLIATA:
- Verificare configurazione CORS per risorse statiche
- Controllare che i font siano serviti con headers corretti

------------------------------------------------------------------------------
BUG #7: MANCANZA VALIDAZIONE DATE PROMOZIONE
------------------------------------------------------------------------------
File: backend/src/server.ts
Linee: 153-170 (create), 173-191 (update)

DESCRIZIONE:
Non viene validato che:
- start_datetime sia nel futuro (o presente)
- end_datetime sia successiva a start_datetime
- Le date siano in formato valido

IMPATTO: Possibile creazione di promozioni con date inconsistenti.

SOLUZIONE CONSIGLIATA:
Aggiungere validazione:
if (new Date(startDatetime) >= new Date(endDatetime)) {
    return res.status(400).json({ error: 'La data di fine deve essere successiva alla data di inizio' });
}

------------------------------------------------------------------------------
BUG #8: PAGINAZIONE TOKEN - CONTEGGIO INCOERENTE
------------------------------------------------------------------------------
File: frontend/app/admin/dashboard/components/TokenListTable.tsx

DESCRIZIONE:
Il componente mostra "Pagina X di Y" ma il calcolo delle pagine totali
potrebbe non corrispondere al numero reale di token se i dati cambiano
durante la navigazione.

IMPATTO: UX confusa, possibile pagina vuota.

SOLUZIONE CONSIGLIATA:
- Sincronizzare il conteggio totale con ogni fetch
- Gestire il caso di pagina vuota con redirect alla prima pagina

================================================================================
                          PROBLEMI MEDI (Priorita 3)
================================================================================

------------------------------------------------------------------------------
BUG #9: ACCESSIBILITA - INPUT PASSWORD
------------------------------------------------------------------------------
File: frontend/app/admin/login/page.tsx
Linea: 134

DESCRIZIONE:
L'input password non ha l'attributo autocomplete="current-password" come
richiesto dalle best practice di accessibilita.

WARNING CONSOLE:
[VERBOSE] [DOM] Input elements should have autocomplete attributes

SOLUZIONE CONSIGLIATA:
<input type="password" autocomplete="current-password" ... />

------------------------------------------------------------------------------
BUG #10: USO ECCESSIVO DI 'any' IN TYPESCRIPT
------------------------------------------------------------------------------
File multipli nel frontend

DESCRIZIONE:
Diversi file usano il tipo 'any' invece di tipi specifici:
- play/page.tsx: prize: any, assignment: any
- admin/login/page.tsx: handleLogin(e: any)
- staff/page.tsx: rawResult: unknown con cast a any

IMPATTO: Perdita dei benefici di type-safety di TypeScript.

SOLUZIONE CONSIGLIATA:
Definire interfacce specifiche per ogni tipo di dato.

------------------------------------------------------------------------------
BUG #11: LOCALSTORAGE NON GESTITO IN SSR
------------------------------------------------------------------------------
File: frontend/app/play/page.tsx, admin/dashboard/page.tsx

DESCRIZIONE:
L'accesso a localStorage avviene senza verificare se siamo in ambiente
browser. Questo potrebbe causare errori durante il Server-Side Rendering.

CODICE PROBLEMATICO:
const savedUser = localStorage.getItem('campari_user');

SOLUZIONE CONSIGLIATA:
if (typeof window !== 'undefined') {
    const savedUser = localStorage.getItem('campari_user');
}

------------------------------------------------------------------------------
BUG #12: PROBABILITY ENGINE - EDGE CASE
------------------------------------------------------------------------------
File: backend/src/services/ProbabilityEngine.ts
Linea: 25

DESCRIZIONE:
L'uso di Math.max(1, totalTokens - usedTokens) previene la divisione per zero
ma potrebbe alterare le probabilita quando tutti i token sono usati.

IMPATTO: Comportamento imprevedibile quando usedTokens >= totalTokens.

SOLUZIONE CONSIGLIATA:
Aggiungere un check esplicito e ritornare null se non ci sono token rimasti:
if (totalTokens <= usedTokens) return null;

------------------------------------------------------------------------------
BUG #13: MANCANZA RATE LIMITING
------------------------------------------------------------------------------
File: backend/src/server.ts

DESCRIZIONE:
Non e implementato alcun rate limiting sugli endpoint API. Un attaccante
potrebbe fare brute-force sui token o sovraccaricare il server.

ENDPOINT A RISCHIO:
- POST /api/customer/play
- GET /api/customer/validate-token/:code
- POST /api/auth/login

SOLUZIONE CONSIGLIATA:
Implementare express-rate-limit:
import rateLimit from 'express-rate-limit';
const limiter = rateLimit({ windowMs: 15 * 60 * 1000, max: 100 });
app.use('/api/', limiter);

------------------------------------------------------------------------------
BUG #14: LIVELEADERBOARD - CONDIZIONE ERRATA
------------------------------------------------------------------------------
File: frontend/app/play/components/LiveLeaderboard.tsx
Linea: 34

DESCRIZIONE:
Il componente non effettua la chiamata API se promotionId O currentCustomerId
sono falsy. Ma currentCustomerId potrebbe essere 0 (falsy ma valido).

CODICE PROBLEMATICO:
if (promotionId && currentCustomerId) { ... }

SOLUZIONE CONSIGLIATA:
if (promotionId && currentCustomerId !== undefined && currentCustomerId !== null) { ... }

================================================================================
                          PROBLEMI BASSI (Priorita 4)
================================================================================

------------------------------------------------------------------------------
BUG #15: CONSOLE.LOG IN PRODUZIONE
------------------------------------------------------------------------------
File: backend/src/server.ts (multiple locations)

DESCRIZIONE:
Diversi console.log e console.error sono presenti nel codice. In produzione
dovrebbe essere usato un logger strutturato.

SOLUZIONE CONSIGLIATA:
Implementare un logger come winston o pino con livelli configurabili.

------------------------------------------------------------------------------
BUG #16: HARDCODED CORS ORIGINS
------------------------------------------------------------------------------
File: backend/src/server.ts
Linee: 72-78

DESCRIZIONE:
Le origini CORS sono hardcoded. Questo rende difficile la configurazione
per ambienti diversi.

SOLUZIONE CONSIGLIATA:
Utilizzare variabili d'ambiente:
const ALLOWED_ORIGINS = process.env.CORS_ORIGINS?.split(',') || ['http://localhost:3000'];

------------------------------------------------------------------------------
BUG #17: MANCANZA ERROR BOUNDARY
------------------------------------------------------------------------------
File: frontend/app/layout.tsx

DESCRIZIONE:
Non e presente un Error Boundary React per catturare errori di rendering
e mostrare una UI di fallback.

SOLUZIONE CONSIGLIATA:
Implementare un ErrorBoundary component che wrappa l'applicazione.

------------------------------------------------------------------------------
BUG #18: FONT LOADING WARNING
------------------------------------------------------------------------------
Console Warning durante la navigazione

DESCRIZIONE:
Warning ripetuti per il caricamento di font woff2:
"The resource ... was preloaded using link preload but not used within a few seconds"

IMPATTO: Performance leggermente degradata, warning nella console.

SOLUZIONE CONSIGLIATA:
- Rimuovere preload non necessari
- Ottimizzare il caricamento dei font

================================================================================
                          MIGLIORAMENTI SUGGERITI
================================================================================

1. TESTING:
   - Aggiungere unit test per ProbabilityEngine
   - Aggiungere integration test per le API
   - Implementare E2E test con Playwright

2. DOCUMENTAZIONE:
   - Aggiungere JSDoc ai componenti principali
   - Documentare le API con OpenAPI/Swagger

3. PERFORMANCE:
   - Implementare caching per le statistiche
   - Ottimizzare le query Prisma con select specifici
   - Implementare pagination server-side per tutti gli elenchi

4. SICUREZZA:
   - Implementare CSRF protection
   - Aggiungere helmet.js per HTTP headers sicuri
   - Implementare logging di audit per operazioni sensibili

5. UX:
   - Aggiungere toast notifications per feedback utente
   - Implementare skeleton loading states
   - Migliorare feedback errori con messaggi piu specifici

================================================================================
                              CONCLUSIONE
================================================================================

L'applicazione e funzionalmente completa e la maggior parte delle feature
funziona correttamente. I problemi critici identificati sono principalmente
legati alla responsiveness su mobile della dashboard admin e a potenziali
edge case nel codice.

Si raccomanda di:
1. Risolvere immediatamente i 3 bug critici prima del rilascio
2. Pianificare la risoluzione dei 5 bug alti per la prima release patch
3. Includere i bug medi nel backlog per le prossime iterazioni

Report generato automaticamente da Claude Code.
================================================================================
